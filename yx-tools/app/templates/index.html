<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare ä¼˜é€‰ IP ç®¡ç†é¢æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
        }

        pre {
            background: #212529;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }

        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }

        .form-text {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2 class="mb-4 text-center">ğŸš€ Cloudflare ä¼˜é€‰ IP ç®¡ç†é¢æ¿</h2>

        <div class="row">
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">âš™ï¸ æ ¸å¿ƒé…ç½®</div>
                    <div class="card-body">
                        <form id="configForm">
                            <div class="mb-3">
                                <label class="form-label">Worker è®¢é˜…/ç®¡ç† URL</label>
                                <textarea class="form-control" id="worker_urls" rows="3"
                                    placeholder="https://example.com/uuid-key&#10;https://example2.com/uuid-key2"></textarea>
                                <div class="form-text">ç›´æ¥ç²˜è´´å®Œæ•´çš„è®¢é˜…é“¾æ¥ï¼Œæ”¯æŒå¤šè¡Œã€‚ç»“æœå°†è‡ªåŠ¨ä¸Šä¼ åˆ°è¿™äº›èŠ‚ç‚¹ã€‚</div>
                            </div>

                            <hr class="my-3">
                            <h6 class="mb-3 text-muted">æµ‹é€Ÿå‚æ•°</h6>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">ä¸‹è½½é€Ÿåº¦ä¸‹é™ (MB/s)</label>
                                    <input type="number" class="form-control" id="speed" value="5">
                                    <div class="form-text">ä½äºæ­¤é€Ÿåº¦çš„ IP å°†è¢«ä¸¢å¼ƒã€‚å»ºè®® 1-10ã€‚</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">æµ‹è¯•æ•°é‡ (Count)</label>
                                    <input type="number" class="form-control" id="count" value="20">
                                    <div class="form-text">æ€»æµ‹é€Ÿ IP æ•°é‡ã€‚è¶Šå¤šè¶Šå‡†ä½†è¶Šæ…¢ã€‚</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">å»¶è¿Ÿé˜ˆå€¼ (ms)</label>
                                    <input type="number" class="form-control" id="delay" value="300">
                                    <div class="form-text">åªä¿ç•™å»¶è¿Ÿä½äºæ­¤å€¼çš„ IPã€‚ä¸€èˆ¬å»ºè®® 300-1000ã€‚</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label">ä¸Šä¼ æ•°é‡ (Top N)</label>
                                    <input type="number" class="form-control" id="upload_count" value="20">
                                    <div class="form-text">å–æµ‹é€Ÿç»“æœæœ€å¥½çš„å‰ N ä¸ª IP ä¸Šä¼ ã€‚</div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label">çº¿ç¨‹æ•° (Thread)</label>
                                    <input type="number" class="form-control" id="thread" value="200">
                                    <div class="form-text">å¹¶å‘æ•°ã€‚é«˜æ€§èƒ½è®¾ 500+ï¼Œè·¯ç”±å»ºè®® 200ã€‚</div>
                                </div>
                                <div class="col-6 mb-3 d-flex align-items-center">
                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" id="ipv6">
                                        <label class="form-check-label" for="ipv6">å¯ç”¨ IPv6 æµ‹é€Ÿ</label>
                                        <div class="form-text">ä»…åœ¨ç½‘ç»œæ”¯æŒ IPv6 æ—¶å¼€å¯ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enable_download">
                                        <label class="form-check-label" for="enable_download">å¯ç”¨ä¸‹è½½æµ‹é€Ÿ</label>
                                        <div class="form-text">é»˜è®¤åªæµ‹å»¶è¿Ÿï¼ˆé€Ÿåº¦å¿«ï¼‰ã€‚å‹¾é€‰åä¼šæµ‹è¯•ä¸‹è½½é€Ÿåº¦ï¼ˆæ›´å‡†ç¡®ä½†æ›´æ…¢ï¼‰ã€‚</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">å®šæ—¶ä»»åŠ¡ (Cron è¡¨è¾¾å¼)</label>
                                <input type="text" class="form-control" id="cron_schedule" value="0 4 * * *"
                                    placeholder="åˆ† æ—¶ æ—¥ æœˆ å‘¨">
                                <div class="form-text">æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨ã€‚ä¾‹: "0 4 * * *" (æ¯å¤©å‡Œæ™¨4ç‚¹)</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ğŸ® æ‰‹åŠ¨æ§åˆ¶</div>
                    <div class="card-body text-center">
                        <button id="runBtn" class="btn btn-success btn-lg w-100 mb-2">â–¶ ç«‹å³è¿è¡Œæµ‹é€Ÿ</button>
                        <div id="statusAlert" class="alert alert-secondary mb-0 py-2 small" role="alert">
                            çŠ¶æ€: <span id="statusText">ç­‰å¾…è¿è¡Œ</span>
                            <span id="lastRunTime" class="ms-2 badge bg-light text-dark border"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ“Š ä¼˜é€‰ç»“æœ (è‡ªåŠ¨åˆ·æ–°)</span>
                        <span class="badge bg-info text-dark" id="resultCount">0 ä¸ªç»“æœ</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0 text-center" style="font-size: 14px;">
                                <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                    <tr>
                                        <th>IP:ç«¯å£</th>
                                        <th>é€Ÿåº¦ (MB/s)</th>
                                        <th>å»¶è¿Ÿ (ms)</th>
                                        <th>åœ°åŒº</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody">
                                    <tr>
                                        <td colspan="4" class="p-3">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ğŸ“ è¿è¡Œæ—¥å¿— (å®æ—¶ - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨)</div>
                    <div class="card-body p-0">
                        <pre id="logArea" style="height: 300px; margin: 0; border-radius: 0 0 5px 5px;">æš‚æ— æ—¥å¿—...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                document.getElementById('worker_urls').value = data.worker_urls || '';
                document.getElementById('speed').value = data.speed || 5;
                document.getElementById('count').value = data.count || 20;
                document.getElementById('delay').value = data.delay || 300;
                document.getElementById('upload_count').value = data.upload_count || 20;
                document.getElementById('thread').value = data.thread || 200;
                document.getElementById('cron_schedule').value = data.cron_schedule || '0 4 * * *';
                document.getElementById('ipv6').checked = data.ipv6 || false;
                document.getElementById('enable_download').checked = data.enable_download || false;
            } catch (e) { console.error(e); }
        }

        // ä¿å­˜é…ç½®
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const config = {
                worker_urls: document.getElementById('worker_urls').value,
                speed: parseFloat(document.getElementById('speed').value),
                count: parseInt(document.getElementById('count').value),
                delay: parseInt(document.getElementById('delay').value),
                upload_count: parseInt(document.getElementById('upload_count').value),
                thread: parseInt(document.getElementById('thread').value),
                cron_schedule: document.getElementById('cron_schedule').value,
                ipv6: document.getElementById('ipv6').checked,
                enable_download: document.getElementById('enable_download').checked
            };
            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            alert('é…ç½®å·²ä¿å­˜ï¼å®šæ—¶ä»»åŠ¡å·²æ›´æ–°ã€‚');
        });

        // æ‰‹åŠ¨è¿è¡Œ
        document.getElementById('runBtn').addEventListener('click', async () => {
            const btn = document.getElementById('runBtn');
            const originalText = btn.innerHTML;

            // Remove confirm dialog for better UX
            // if (!confirm('ç¡®å®šè¦ç«‹å³å¼€å§‹æµ‹é€Ÿå—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚')) return;

            // Visual feedback immediately
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ­£åœ¨å¯åŠ¨...';

            try {
                await fetch('/api/run', { method: 'POST' });

                // Update status display
                const statusBadge = document.getElementById('statusAlert');
                statusBadge.className = 'alert alert-info mb-0 py-2 small';
                document.getElementById('statusText').textContent = 'ğŸš€ ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨å€™...';

                // Reset button after short delay
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 2000);
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // åŠ è½½ç»“æœ
        async function loadResults() {
            try {
                const res = await fetch('/api/results');
                const data = await res.json();
                const tbody = document.getElementById('resultsBody');
                document.getElementById('resultCount').textContent = `${data.length} ä¸ªç»“æœ`;

                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-muted">æš‚æ— æµ‹é€Ÿç»“æœï¼Œè¯·å…ˆç‚¹å‡»"ç«‹å³è¿è¡Œ"æˆ–ç­‰å¾…å®šæ—¶ä»»åŠ¡ã€‚</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');
                    const ip = row['IP åœ°å€'] || row['ip'] || row['IP'];
                    const port = row['ç«¯å£'] || row['port'] || row['Port'];
                    const speed = row['ä¸‹è½½é€Ÿåº¦(MB/s)'] || row['ä¸‹è½½é€Ÿåº¦ (MB/s)'] || row['speed'] || 'N/A';
                    const latency = row['å¹³å‡å»¶è¿Ÿ'] || row['delay'] || 'N/A';
                    const region = row['åœ°åŒºç '] || 'Unknown';

                    tr.innerHTML = `
                        <td class="font-monospace">${ip}:${port}</td>
                        <td class="text-success fw-bold">${speed}</td>
                        <td>${latency}</td>
                        <td><span class="badge bg-secondary">${region}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { e.textContent = "åŠ è½½å¤±è´¥"; }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const res = await fetch('/api/logs');
                const lines = await res.json();
                const logArea = document.getElementById('logArea');

                // Keep chronological order (Old -> New) for readability
                // Because reading multi-line logs backwards (e.g. Header after Progress) is very confusing.
                // We will use Auto-scroll to keep the view at the bottom.

                const newText = lines.join('').trim() || 'ç­‰å¾…æ—¥å¿—...';

                if (logArea.textContent !== newText) {
                    const wasAtBottom = Math.abs(logArea.scrollHeight - logArea.scrollTop - logArea.clientHeight) < 50;

                    logArea.textContent = newText;

                    // Auto-scroll to bottom if we were already there OR if it's the first load
                    if (wasAtBottom || logArea.scrollTop === 0) {
                        logArea.scrollTop = logArea.scrollHeight;
                    }
                }
            } catch (e) { console.error(e); }
        }

        // åŠ è½½è¿è¡ŒçŠ¶æ€
        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const statusText = document.getElementById('statusText');
                const lastRunTime = document.getElementById('lastRunTime');
                const alertBox = document.getElementById('statusAlert');

                statusText.textContent = data.message;
                lastRunTime.textContent = data.last_run !== '-' ? `æœ€åæ›´æ–°: ${data.last_run}` : '';

                if (data.message.includes('æˆåŠŸ')) {
                    alertBox.className = 'alert alert-success mb-0 py-2 small';
                } else if (data.message.includes('å¤±è´¥') || data.message.includes('å‡ºé”™')) {
                    alertBox.className = 'alert alert-danger mb-0 py-2 small';
                } else if (data.message.includes('è¿è¡Œä¸­')) {
                    alertBox.className = 'alert alert-primary mb-0 py-2 small';
                }
            } catch (e) { console.error(e); }
        }

        // åˆå§‹åŒ–
        loadConfig();
        loadResults();
        loadLogs();
        loadStatus();

        // å®šæ—¶åˆ·æ–°
        setInterval(loadResults, 5000);
        setInterval(loadLogs, 1000); // Faster log polling (1s)
        setInterval(loadStatus, 3000);
    </script>
</body>

</html>